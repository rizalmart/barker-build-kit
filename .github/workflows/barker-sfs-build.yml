name: Build Puppy Main SFS + initrd

on:
  #schedule:
    #- cron: '0 2 */20 * *' # daily at 02:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: debian:sid

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            busybox \
            squashfs-tools wget xz-utils ca-certificates \
            wget kmod curl cpio coreutils python3 libgtk-3 \
            libgtk2.0 libvte libgtk-layer-shell libayatana-appindicator3 \
            libatk1.0 libpango1.0 libcairo2 libgdk-pixbuf-2.0

      - name: Building debian puppy filesystem
        shell: bash
        run: |
        
              . ./DISTRO_SPECS

              echo "DISTRO_NAME=$DISTRO_NAME" >>  $GITHUB_ENV
              echo "DISTRO_VERSION=$DISTRO_VERSION" >>  $GITHUB_ENV
              echo "DISTRO_PUPPYSFS=$DISTRO_PUPPYSFS" >>  $GITHUB_ENV

              export TERM=xterm
              
              chmod +x ./01-build-debian-puppy.sh
              ./01-build-debian-puppy.sh

      - name: Building compiling puppy core applications
        shell: bash
        run: |
             . ./build-settings.cfg
             cp -rf ./puppy-source-builds /
             chmod +x ./external-tools/compile-puppy-core-apps.sh
             ./external-tools/compile-puppy-core-apps.sh
              cp -rf /usr/local/* $ROOTFS/usr/local/
              
      - name: Packing puppy filesystem into main sfs file
        shell: bash
        run: |      
              chmod +x ./03-pack-sfs.sh
              ./03-pack-sfs.sh
      
      - name: Process initrd
        shell: bash
        run: |              
              chmod +x ./04-process-initrd.sh
              ./04-process-initrd.sh
      
      - name: Putting output build to tarball
        shell: bash
        run: |                            
              tar -cJf $DISTRO_NAME-$DISTRO_VERSION.tar.xz -C puppy-livecd-build .              

      - name: Upload output build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DISTRO_NAME }} ${{ env.DISTRO_VERSION }} main SFS files + initrd
          path: ${{ env.DISTRO_NAME }}-${{ env.DISTRO_VERSION }}.tar.xz
          compression-level: 0 
