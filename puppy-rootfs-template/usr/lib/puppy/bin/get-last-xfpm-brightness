#!/bin/bash

WMPATH=/etc/windowmanager

[ -e "${HOME}/.config/windowmanager" ] && WMPATH="${HOME}/.config/windowmanager"

[ "$(cat $WMPATH | grep "xfce")" == "" ] && exit

[ "$(which xfpm-power-backlight-helper)" == "" ] && exit

if [ ! -e /sys/class/backlight ] || [ "$(ls /sys/class/backlight 2>/dev/null)" == "" ]; then
 exit
fi

MAX_BRIGHT="$(xfpm-power-backlight-helper --get-max-brightness 2>/dev/null)"

if [ "$MAX_BRIGHT" == "" ] || [ $MAX_BRIGHT -le 0 ]; then 
 exit
fi

[ ! -e ~/.config/last_screen_brightness ] && FIRST_RUN=1

if [ "$FIRST_RUN" == "" ]; then
 LAST_BRIGHT="$(cat ~/.config/last_screen_brightness)"
 [ "$LAST_BRIGHT" == "" ] && LAST_BRIGHT=0
else
 LAST_BRIGHT="$(expr $MAX_BRIGHT / 2)"
fi

if [ $LAST_BRIGHT -gt $MAX_BRIGHT ]; then
 LAST_BRIGHT="$(expr $MAX_BRIGHT / 2)"
fi

pkexec xfpm-power-backlight-helper --set-brightness $LAST_BRIGHT
