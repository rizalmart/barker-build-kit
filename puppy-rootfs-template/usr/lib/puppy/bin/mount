#!/bin/bash
#BK 2006 www.puppylinux.com
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#v407 fix for floppy drive icon.
#v409 gparted create ext3 part. failed, fixed by making /etc/mtab a symlink.
#120103 shinobar: need 'silent' option for ntfs-3g, avoid err msgs, permissions lost when copy.
#130203 change probedisk2 to probedisk.

#mount-FULL, umount-FULL, losetup-FULL are the full versions.
#The Busybox versions of mount and umount are available but only by:
# # busybox mount ...
# # busybox umount ...
#mount and umount are now scripts.
#if an ntfs partition, puppy uses user-mode ntfs-3g driver.
#the mount and umount scripts allow seamless mounting and unmounting of ntfs f.s.

[ "$1" == "" ] && exec busybox mount

if [ "`whoami`" != "root" ] ; then
	exec sudo -A ${0} ${@}
fi

WCOMPOSITOR="$(cat /etc/wayland-compositors.list 2>/dev/null | tr '\n' ' ')"

if [ "$(busybox pidof -s X Xorg $WCOMPOSITOR)" != "" ]; then
 [ "$DISPLAY" == "" ] && export DISPLAY=:0
 [ "$WAYLAND_DISPLAY" == "" ] && export WAYLAND_DISPLAY=wayland-0
 [ "$XDG_RUNTIME_DIR" == "" ] && export XDG_RUNTIME_DIR=/run/runtime-root
 XRUNNING="y"
else
 XRUNNING=""
fi

# non-root:
#   ntfs-3g and probably other weird drivers might not let the user
#   see the files unless the fs is mounted with a proper uid and gid
if [ ! "$USER_ID" ] ; then
	[ -f /tmp/services/user_info ] && . /tmp/services/user_info
fi

if [ "$USER_ID" ] ; then
	USER_OPTS="uid=${USER_ID},gid=${USER_GROUP_ID},"
	USER_OPTS_2="-o uid=${USER_ID},gid=${USER_GROUP_ID}"
fi

#i realised this script has to allow reentrancy. So, all temp file now unique,
#using ${$} which is pid of script.
MYPID=${$}

MOUNT_BIN=/bin/mount

[ -L $MOUNT_BIN ] && MOUNT_BIN=$(readlink $MOUNT_BIN)

if [ "$(file $MOUNT_BIN | grep "ELF" | grep "LSB")" != "" ] && [ "$(basename $MOUNT_BIN)" != "busybox" ]; then
 MOUNT_EXEC=$MOUNT_BIN
else
	
	MOUNT_BIN=/bin/mount-FULL
	
	[ -L $MOUNT_BIN ] && MOUNT_BIN=$(readlink $MOUNT_BIN)

	if [ "$(file $MOUNT_BIN | grep "ELF" | grep "LSB")" != "" ] && [ "$(basename $MOUNT_BIN)" != "busybox" ]; then
	 MOUNT_EXEC=$MOUNT_BIN 
	else
	 MOUNT_EXEC="busybox mount"
	fi
	
fi

#v2.12 discovered difference between $@ and $*. Replaced all $@ with $* in this script...

#extract all the '-' options, on separate lines... do NOT use $@!!!!...
#v3.93 eliminate ' -- ' and all past it...
DASHOPTS="`echo "$*" | tr '\t' ' '  | sed -e 's/ -- .*//' | tr ' ' '\n' | grep '^\-'`"

case "$*" in
	*' vfat '*) VFAT_FLAG=yes ;;
	*' exfat '*) EXFAT_FLAG=yes ;;
	*' ntfs '*) NTFS_FLAG=yes ;;
	*' ntfs3 '*) NTFS_FLAG=yes ;;
	*' btrfs '*) BTRFS_FLAG=yes ;;
	*' ext4 '*) EXT4_FLAG=yes ;;
	*' crypto_LUKS '*) LUKS_FLAG=yes ;;
esac

if [ "$VFAT_FLAG" = "yes" ];then
  case "$@" in
    *"-o "*) #don't override -o
      ${MOUNT_EXEC} -n "${@}"
      ;;
    *)
      
      CMDPRMS="`echo -n "$*" | tr '\t' ' ' | tr -s ' ' | tr ' ' '\n' | grep '^/' | tr '\n' ' '`"
      
      NLS_PARAM=""
      
      if [ -f /etc/codepage ]; then
        grep -q -i '850' /etc/codepage && [ "$(echo $LANG|cut -d'.' -f1)" != "en_US" ] && NLS_PARAM=",codepage=850"
        grep -q -i '852' /etc/codepage && NLS_PARAM=",codepage=852,iocharset=iso8859-2"
      fi
      
      grep '^LANG=' /etc/profile | grep -q -i -E '\.utf|\.UTF' && NLS_PARAM="$NLS_PARAM,utf8"
      
      OPT="-o ${USER_OPTS}shortname=mixed,flush,noatime,quiet${NLS_PARAM}"
      
      ${MOUNT_EXEC} -t vfat ${OPT} -n $CMDPRMS
      
      ;;
  esac
  
  RETVAL=$?

elif [ "$EXFAT_FLAG" = "yes" ];then
  
    case "$@" in
    *"-o "*) #don't override -o
      ${MOUNT_EXEC} -n "${@}"
    ;;
    *)
      
      CMDPRMS="`echo -n "$*" | tr '\t' ' ' | tr -s ' ' | tr ' ' '\n' | grep '^/' | tr '\n' ' '`"
      
      OPT="-o ${USER_OPTS}noatime,utf8"
      
      ${MOUNT_EXEC} -t exfat ${OPT} -n $CMDPRMS
      
    ;;
    esac  
  
  RETVAL=$?

elif [ "$BTRFS_FLAG" = "yes" ];then
  
    case "$@" in
    *"-o "*) #don't override -o
      ${MOUNT_EXEC} -n "${@}"
    ;;
    *)
      
      CMDPRMS="`echo -n "$*" | tr '\t' ' ' | tr -s ' ' | tr ' ' '\n' | grep '^/' | tr '\n' ' '`"
      
      OPT="-o noatime,space_cache=v2,autodefrag,commit=10"
      
      ${MOUNT_EXEC} -t btrfs ${OPT} -n $CMDPRMS
      
    ;;
    esac  
  
  RETVAL=$?
elif [ "$EXT4_FLAG" = "yes" ];then
  
    case "$@" in
    *"-o "*) #don't override -o
      ${MOUNT_EXEC} -n "${@}"
    ;;
    *)
      
      CMDPRMS="`echo -n "$*" | tr '\t' ' ' | tr -s ' ' | tr ' ' '\n' | grep '^/' | tr '\n' ' '`"
      
      OPT="-o noatime,commit=10,barrier=1,data=ordered,journal_checksum"
      
      ${MOUNT_EXEC} -t ext4 ${OPT} -n $CMDPRMS
      
    ;;
    esac  
  
  RETVAL=$?      

elif [ "$LUKS_FLAG" = "yes" ] ; then
  exec mount.crypto_LUKS "$@" #mount.crypto_LUKS has specific rox code

elif [ "$NTFS_FLAG" = "yes" ];then

  KVER=$(uname -r)
  KMAJOR=$(echo $KVER | cut -f 1 -d '-' | cut -f 1 -d '.')
  KMINOR=$(echo $KVER | cut -f 1 -d '-' | cut -f 2 -d '.')
  

  case "$@" in
    *"-o "*) #don't override -o
    
    if [ "$(grep -m1 "ntfs3" /proc/filesystems 2>/dev/null)" != "" ]; then
      USE_NTFS3="y"
    elif modprobe -q ntfs3 2>/dev/null; then
      USE_NTFS3="y"
    else
      USE_NTFS3=""
    fi  
    
     NTFS_3G="y" 
      
      if [ "$USE_NTFS3" != "" ]; then
       
       ${MOUNT_EXEC} "$(echo "${@}" | sed -e 's#\ ntfs\ #\ ntfs3\ #')"
       RETVAL=$?
       
	   if [ $RETVAL -eq 0 ]; then
	    NTFS_3G="" 
	   else
	   
	     for arg1 in ${@}
	     do
	      if [ "$(echo "$arg1" | grep "/")" != "" ]; then
	       ptn="$arg1"
	       break
	      fi
	     done
	     
	     if [ "$ptn" != "" ]; then
	      [ "$(mount | grep -ow "$ptn")" != "" ] && NTFS_3G="" 
	     fi
	     
	   fi
	  
	  fi	
      
      if [ "$USE_NTFS3" == "" ]; then
         [ ! -d /tmp/ntfs-errors ] && mkdir -p /tmp/ntfs-errors
	  fi
	  
      if [ "$NTFS_3G" != "" ]; then
       ntfs-3g "${@}" || ${MOUNT_EXEC} "${@}"
       RETVAL=$?
      fi
      
      RETVAL=$?
      
      ;;
    *)
    
      #screen out all the options...
      CMDPRMS="`echo -n "$*" | tr '\t' ' ' | tr -s ' ' | tr ' ' '\n' | grep '^/' | tr '\n' ' '`"
      #kirk advised these options so Rox will not complain about file
      #permissions when copy a file to a ntfs partition...

	  if [ "$(grep -m1 "ntfs3" /proc/filesystems 2>/dev/null)" != "" ]; then
	   USE_NTFS3="y"
	  elif modprobe -q ntfs3 2>/dev/null; then
	   USE_NTFS3="y"
	  else
	   USE_NTFS3=""
	  fi  
     
      NTFS_3G="y" 
     	
	  if [ "$USE_NTFS3" != "" ]; then
	  
	   NTFS3_PARAM="${USER_OPTS},prealloc,noatime,iocharset=utf8"
	  
	   if [ $KMAJOR -ge 6 ] && [ $KMINOR -ge 2 ]; then
         NTFS3_PARAM="${NTFS3_PARAM},nocase,windows_names"	   
       fi
       
       busybox mount -t ntfs3 -o ${NTFS3_PARAM} $CMDPRMS
       
       RETVAL=$?
       
       if [ $RETVAL -ne 0 ]; then
        busybox mount -t ntfs3 -o ${NTFS3_PARAM},force $CMDPRMS 
        RETVAL=$?
       fi
       
       if [ $RETVAL -eq 0 ]; then
        NTFS_3G=""  
       else
       
       	 for arg1 in $CMDPRMS
	     do
	      if [ "$(echo "$arg1" | grep "/")" != "" ]; then
	       ptn="$arg1"
	       break
	      fi
	     done
	     
	     if [ "$ptn" != "" ]; then
	      [ "$(mount | grep -ow "$ptn")" != "" ] && NTFS_3G="" 
	     fi
       
       fi
      
      fi
      
      
      if [ "$NTFS_3G" != "" ]; then
      
      [ ! -d /tmp/ntfs-errors ] && mkdir -p /tmp/ntfs-errors
      
	  [ -f /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt ] && rm -f /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt     
      
      ntfs-3g $CMDPRMS -o ${USER_OPTS}silent 2>/tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt
      RETVAL=$?

      #v2.16 ntfs-3g v1.417, part. scheduled for check, failed with value 10...
      #v4.00 ntfs-3g v1.2412 does not have 4,10, has 15 for dirty f.s., 14 hiberneted...
      case $RETVAL in 4|10|15) #14 = must mount read-only

        ntfs-3g $CMDPRMS -o ${USER_OPTS}force,silent 2>/tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt
        
        RETVAL=$?
        
        ERRMSG1="`cat /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt`"

        echo "$ERRMSG1"

        if [ $RETVAL -eq 0 ];then
         
         echo "WARNING: NTFS f.s. mounted read/write but corrupted."
         
         [ "$XRUNNING" != "" ] && nohup gxmessage -bg red -center -title "NTFS WARNING" "The ntfs-3g driver was able to mount the NTFS
partition but returned this error message:

$ERRMSG1

It is mounted read/write, but advice is only write
to it in emergency situation. Recommendation is
boot Windows and fix the filesystem first!!!" &
        
        fi
        
       ;;
      *)
       if [ $RETVAL -eq 0 ];then
        rm -f /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt 2>/dev/null
       fi
      ;;
      esac
	
	
	  fi	
		
		
      #ntfs-3g plays very safe and will not mount if thinks anything
      #wrong with ntfs f.s. But, we may want to recover files from a
      #damaged windows. So, fall back to the kernel ntfs driver...
      if [ ! $RETVAL -eq 0 ];then
      
       #mount read-only...
       busybox mount -r -t ntfs $CMDPRMS
       RETVAL=$?
       ERRMSG1="`cat /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt`"
       echo "$ERRMSG1"
       
       if [ $RETVAL -eq 0 ];then
        echo "WARNING: NTFS f.s. mounted read-only."
        
        NTFS_DRV="ntfs3"
        
        [ "$USE_NTFS3" == "" ] && NTFS_DRV="ntfs-3g"
        
        [ ! "`pidof X`" = "" ] && nohup gxmessage -bg red -center -title "NTFS WARNING" "The $NTFS_DRV driver was unable to mount the NTFS
partition and returned this error message:

$ERRMSG1

So, the inbuilt kernel legacy NTFS driver has been used
to mount the partition read-only." &
       else
        rm -f /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt 2>/dev/null
       fi
      else
       rm -f /tmp/ntfs-errors/ntfsmnterr-${MYPID}.txt 2>/dev/null
      fi
      
      ;;
  esac

### everything else ###
else
  #needs an explicit '-t ntfs', does not work with /etc/fstab...
  # busybox mount does not support '--bind'
  # as have mtab file (see below), can now use full mount...
  # v409 put in '-n' option as now have /etc/mtab symlink to /proc/mounts...
  ${MOUNT_EXEC} -n "${@}" #SFR quotes
  RETVAL=$?
fi

if [ $RETVAL -eq 0 ] ; then
	if [ -f /usr/local/pup_event/frontend_rox_funcs ] ; then
		#ROX: create or refresh desktop icon
		/usr/local/pup_event/frontend_rox_funcs rox_mount "$DEVNAME"
	fi
fi

#v409, instead just make sure the symlink stays there...
if [ ! -L /etc/mtab ] && [ -f /proc/mounts ];then
 rm -f /etc/mtab
 ln -s /proc/mounts /etc/mtab
fi

exit $RETVAL
