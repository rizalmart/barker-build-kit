#!/bin/sh
#Barry Kauler Dec. 2010, license GPL v3 /usr/share/doc/legal.
#based on a script by technosaurus, Dec. 2010.

#set -x

[ "`whoami`" != "root" ] && exec sudo -A ${0} ${@} #110505

export TEXTDOMAIN=repack_builtin
export OUTPUT_CHARSET=UTF-8

eval_gettext () {
  local myMESSAGE=$(gettext "$1")
  eval echo \"$myMESSAGE\"
}

Yes_lbl="$(gettext 'Yes')"
No_lbl="$(gettext 'No')"

MSG1="`gettext \"Simple utility to 'repack' packages that are builtin\nto the read-only .sfs file (Squashfs filesystem)\"`"
FIXMENU='no'

D=/var/packages/builtin_files

#===========================================================

repack_builtin_pkg() {
	
	PKG=$1
	
	if [ -z "$PKG" ] ; then
		return 1
	fi
	if [ ! -f $D/$PKG ] ; then
		echo "$PKG does not exist.."
		return 1
	fi
	
	echo "Repacking $PKG"
	
    if [ ! -d /tmp/${PKG} ]; then
      mkdir -p /tmp/${PKG}
    fi
    	   
	cat $D/$PKG | sort -r | 
	while read file
	do
		if [ -f "$file" ]; then
		  cp --parents -f "$file" "/tmp/${PKG}/"
		elif [ -L "$file" ]; then
		  cp --parents -f -P "$file" "/tmp/${PKG}/"
		fi			
	done
		
   prechar="+"
      
    if [ -e "/var/packages/package-specs/${PKG}.specs" ]; then
     reg1=`cat "/var/packages/package-specs/${PKG}.specs" | head -n 1`
    else
     reg1=`cat /var/packages/woof-installed-packages | grep "|${PKG}|" | grep -v "$prechar${PKG}"`
     reg2=`cat /var/packages/woof-installed-packages | grep "${PKG}|" | grep -v "$prechar${PKG}"`
    fi
    
    if [ "$reg1" != "" ]; then
     echo "$reg1" > /tmp/${PKG}/pet.specs
    else
     echo "$reg2" > /tmp/${PKG}/pet.specs
    fi
   
    cd /tmp
   
    tar -cf "${PKG}.tar" "./${PKG}"
    gzip "./${PKG}.tar"
    tgz2pet "./${PKG}.tar.gz"
   
    if [ ! -d /root/builtin-pkg ]; then
     mkdir /root/builtin-pkg
    fi
   
    mv "/tmp/${PKG}.pet" "/root/builtin-pkg/${PKG}.pet"
   
    rm -rf /tmp/${PKG}
	
    return 0
	
}

#===========================================================
#                   COMMAND LINE
#============================================================

case $1 in -l|-list|--list)

	for pkg1 in `ls -1 $D`
	do
	 if [ "$(cat /var/packages/woof-installed-packages 2>/dev/null | grep "|$pkg1|")" != "" ]; then
	  echo $pkg1
	 fi
	done
	
	exit ;;
esac

if [ "$1" ] ; then
	for i in $@
	do
		repack_builtin_pkg $i
	done
	fix_menus
	exit $?
fi

#===========================================================
#                    GUI
#============================================================

for prepkg in `ls -1 $D`
do
 if [ "$(cat /var/packages/woof-installed-packages 2>/dev/null | grep "|$prepkg|")" != "" ]; then
  if [ "$PKGS" == "" ]; then
   PKGS="$prepkg"
  else
   PKGS="$PKGS $prepkg"
  fi
 fi
done

DIALOG="dialog --aspect 10"
MENUOPT="--checklist"
REP=/tmp/$(basename $0).txt

if [ "$DISPLAY" ] || [ "$WAYLAND_DISPLAY" ]; then
	DIALOG=Xdialog
fi

for i in $PKGS ; do
	CHOICES="$CHOICES $i . off"
done

PKG=`$DIALOG --stdout --backtitle "${MSG1}" --title "$(gettext 'Repack builtin packages')" \
$MENUOPT "$(gettext 'Select packages to repack (be careful):')" 0 0 7 $CHOICES`
if [ ! "$PKG" ];then
	exit
fi

PKG=$(echo "$PKG" | sed 's%/% %g')
/usr/lib/gtkdialog/box_yesno --warning "Repack builtin pkg(s)" \
	"Please confirm that you want to repacked the following pkg(s):" "" \
	"<b>$PKG</b>"
if [ $? -ne 0 ] ; then
	exit
fi

#--
repacked_PKGS=''
#--

for i in $PKG
do
	repack_builtin_pkg $i || continue
	repacked_PKGS="$repacked_PKGS $i"
done

if [ "${repacked_PKGS}" ] ; then
	/usr/lib/gtkdialog/box_ok "Repack builtin pkg(s)" info  \
		"The following packages were repacked:" "" "<b>${repacked_PKGS}</b>"
fi

### END ###
