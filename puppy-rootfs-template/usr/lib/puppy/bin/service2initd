#!/bin/bash
#Converts systemd .service file into init.d script
#Written by mistfire

SRVFILE="$1"



if [ "$SRVFILE" == "" ] || [ ! -e "$SRVFILE" ]; then
 exit
fi



SRVNAME="$(basename $SRVFILE .service)"

if [ "$(grep -h -E '^Type\ =|^Type=' $SRVFILE | grep -E 'dbus|udev')"  == "" ]; then
	 
	 SRVTYPE="$(grep -m 1 '^Type=' $SRVFILE)"
	 
	 EXECCMD="$(grep -m 1 '^ExecStart=' $SRVFILE | sed -e 's#^ExecStart=##g')"
	 
	 PREEXEC="$(grep -m 1 '^ExecStartPre=' $SRVFILE | sed -e 's#^ExecStartPre=##g')"
	 
	 POSTEXEC="$(grep -m 1 '^ExecStartPost=' $SRVFILE | sed -e 's#^ExecStart=##g')"
	 
	 EXECSTOP="$(grep -m 1 '^ExecStop=' $SRVFILE | sed -e 's#^ExecStop=##g')"
	 
	 POSTEXECSTOP="$(grep -m 1 '^ExecStopPost=' $SRVFILE | sed -e 's#^ExecStopPost=##g')"
	 
	 RELOADEXEC="$(grep -m 1 '^ExecReload=' $SRVFILE  | sed -e 's#^ExecReload=##g')"

	 

	 PIDFILE="$(grep -h '^PIDFile=' $SRVFILE | cut -f 2 -d '=' | xargs)"
	 KILLSIG="$(grep -h '^KillSignal=' $SRVFILE | cut -f 2 -d '=' | xargs)"
	 WKDIR="$(grep -h '^WorkingDirectory=' $SRVFILE | cut -f 2 -d '=' | xargs)"
	 ENVFILE="$(grep -h '^EnvironmentFile=' $SRVFILE | cut -f 2 -d '=' | xargs | sed -e "s#^\-##g" -e "s#^\+##g" -e "s#^\@##g" -e "s#^:##g")"
	 ENV_VALUES="$(grep -h '^Environment=' $SRVFILE | sed -e 's#^Environment=##')"
	 WANTED="$(grep -h '^WantedBy=' $SRVFILE | cut -f 2 -d '=' | xargs)"
	 
	 
	 
	     [ "$PIDFILE" == "" ] && PIDFILE="/var/run/${SRVNAME}.pid"
	 
		 
		 if [ "$SRVTYPE" == "forking" ]; then
           BCKPID=' &'
         elif [ "$SRVTYPE" != "oneshot" ]; then
           BCKPID=''
         else
           BCKPID=''
         fi
	 
echo '#!/bin/sh
#script generated by service2initd
ARG1="$1"

'   

    if [ "$ENVFILE" != "" ]; then
     grep -h '^EnvironmentFile=' $SRVFILE | sed -e 's#^EnvironmentFile=##' | sed -e "s#^\-##g" -e "s#^\+##g" -e "s#^\@##g" -e "s#^:##g" | while read efile
     do
	  #[ -e $efile ] && echo ' . '$efile
	  echo ' . '$efile
	 done
    fi


    if [ "$ENV_VALUES" != "" ]; then
      grep -h '^Environment=' $SRVFILE | sed -e 's#^Environment=##' | while read ENV1
      do
       echo $ENV1
      done
    fi

echo '
start_service(){
echo
'

if [ "$WANTED" != "shutdown.target" ] && [ "$WANTED" != "final.target" ] ; then    
    

    [ "$SRVTYPE" != "oneshot" ] && echo ' rm -f '$PIDFILE' 2>/dev/null'
	
    [ "$WKDIR" != "" ] && echo ' cd '$WKDIR
    
    if [ "$PREEXEC" != "" ]; then
 
       grep -h '^ExecStartPre=' $SRVFILE | sed -e 's#^ExecStartPre=##g'  | while read LINE1
       do      
         echo ' '$LINE1
       done
       
    fi
    

    if [ "$EXECCMD" != "" ]; then
      
      grep -h '^ExecStart=' $SRVFILE | sed -e 's#^ExecStart=##g' | while read LINE1
      do
        echo ' '$LINE1''$BCKPID
 	  done
 	  
 	fi
 	
 	
    if [ "$POSTEXEC" != "" ]; then
 
       grep -h '^ExecStartPost=' $SRVFILE | sed -e 's#^ExecStartPost=##g' | while read LINE1
       do      
         echo ' '$LINE1
       done
       
    fi	


else

 echo 'exit'

fi
	
echo '
}

stop_service(){
echo
'

	if [ "$WANTED" == "shutdown.target" ] || [ "$WANTED" == "final.target" ] ; then    
		
		
		[ "$WKDIR" != "" ] && echo ' cd '$WKDIR
		
		if [ "$PREEXEC" != "" ]; then
	 
		   grep -h '^ExecStartPre=' $SRVFILE | sed -e 's#^ExecStartPre=##g' |  while read LINE1
		   do      
			 echo ' '$LINE1
		   done
		   
		fi
		

		if [ "$EXECCMD" != "" ]; then
		  
		  grep -h '^ExecStart=' $SRVFILE | sed -e 's#^ExecStart=##g' | while read LINE1
		  do
			echo ' '$LINE1''$BCKPID
		  done
		  
		fi
		
		
		if [ "$POSTEXEC" != "" ]; then
	 
		   grep -h '^ExecStartPost=' $SRVFILE | sed -e 's#^ExecStartPost=##g' | while read LINE1
		   do      
			 echo ' '$LINE1
		   done
		   
		fi	


	fi


    if [ "$EXECSTOP" != "" ]; then
 
       grep -h '^ExecStop=' $SRVFILE | sed -e 's#^ExecStop=##g' | while read LINE1
       do      
         echo ' '$LINE1
       done
       
    fi	
    

    if [ "$POSTEXECSTOP" != "" ]; then
 
       grep -h '^ExecStopPost=' $SRVFILE | sed -e 's#^ExecStopPost=##g'  | while read LINE1
       do      
         echo ' '$LINE1
       done
       
    fi	
	
echo '
}


case $ARG1 in
start)
 start_service
;;
stop)
 stop_service
;;'

if [ "$WANTED" != "shutdown.target" ] && [ "$WANTED" != "final.target" ] ; then  

echo 'restart)
 stop_service 
 sleep 1
 start_service
;;'

fi

if [ "$RELOADEXEC" != "" ]; then
echo 'reload|force-reload)
echo
'
   
    grep -h '^ExecReload=' $SRVFILE  | sed -e 's#^ExecReload=##g' | while read LINE1
    do      
      echo ' '$LINE1
    done
 
echo ';;'
fi

echo 'esac
'
   
fi
