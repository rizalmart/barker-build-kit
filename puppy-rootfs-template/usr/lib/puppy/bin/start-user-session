#!/bin/bash
#120221 moved this code here from /etc/profile, also take 'exec' prefix off call to xwin.

export USER="$(whoami)"

if [ ! -e /tmp/services/user_info_${USER} ]; then

mkdir -p /tmp/services
(
	echo "USER=$(id -un)"
	echo "USER_ID=$(id -u)"
	echo "USER_GROUP=$(id -gn)"
	echo "USER_GROUP_ID=$(id -g)"
	echo "LANG='${LANG}'"
	echo "HOME='${HOME}'"
	echo "PATH='${PATH}'"
) > /tmp/services/user_info_${USER}

fi

#===============================================
############MISC DESKTOP STUFF##################

USER_HOME=$(awk -F: '$1=="'${USER}'" {print $6}' /etc/passwd)

. /etc/rc.d/PUPSTATE

case $PUPMODE in
	77) APP='savesession-dvd' ;;
	13) APP='save2flash'      ;;
esac

if [ -f ${USER_HOME}/Choices/ROX-Filer/PuppyPin ] ; then
	case $PUPMODE in
	77|13) #77=multisession cd/dvd. 13=#pup_rw is tmpfs. pmedia=usbflash
		if [ "`cat ${USER_HOME}/Choices/ROX-Filer/PuppyPin | grep "${APP}"`" = "" ];then
			echo "<icon x=\"768\" y=\"128\" label=\"save\">/usr/sbin/${APP}</icon>" >> ${USER_HOME}/Choices/ROX-Filer/PuppyPin
			grep -v '/pinboard' ${USER_HOME}/Choices/ROX-Filer/PuppyPin  > /tmp/PuppyPin-CPY
			cp -f /tmp/PuppyPin-CPY ${USER_HOME}/Choices/ROX-Filer/PuppyPin
			echo '</pinboard>' >> ${USER_HOME}/Choices/ROX-Filer/PuppyPin
		fi
		;;
	*)
		sed -i -e '/savesession-dvd/d' -e '/save2flash/d' ${USER_HOME}/Choices/ROX-Filer/PuppyPin
		;;
	esac
fi

case $PUPMODE in
	77|13) #77=multisession cd/dvd. 13=#pup_rw is tmpfs. pmedia=usbflash
		if [ ! -f ${USER_HOME}/Desktop/${APP}.desktop ] ; then
			mkdir -p ${USER_HOME}/Desktop
			echo "[Desktop Entry]
Encoding=UTF-8
Name=${APP}
Exec=${APP}
Terminal=false
Type=Application
Icon=/usr/share/pixmaps/puppy/save.svg" > ${USER_HOME}/Desktop/${APP}.desktop
			chmod +x ${USER_HOME}/Desktop/${APP}.desktop
		fi
	;;
	*)
		rm -f ${USER_HOME}/Desktop/save2flash.desktop ${USER_HOME}/Desktop/savesession-dvd.desktop
	;;
esac

#######

DM_LIST="$(cat /etc/display-managers.list 2>/dev/null | tr '\n' ' ')"

#start display server
 if [ "$WAYLAND_DISPLAY" == "" ] && [ "$DISPLAY" == "" ]; then 
   if [ "$DM_LIST" != "" ] && [ "$(busybox pidof $DM_LIST)" != "" ]; then
     xhost +local:
   else
	 exec start-display-server
   fi
 else
   xhost +local:
 fi

### END ###
