#!/bin/sh
#Initial xorg setup
#written by mistfire

reset_monitor_settings() {

rm -f /var/lib/gdm/.config/monitors.xml 2>/dev/null

for lxpath2 in /etc/xdg $HOME/.config
do 
 if [ -e $lxpath2/autostart/lxrandr-autostart.desktop ]; then
  rm -f $lxpath2/autostart/lxrandr-autostart.desktop 2>/dev/null
 fi
done

for xfcepath in /etc/xdg/xfce4 /etc/xdg/xfce $HOME/.config/xfce4 $HOME/.config/xfce
do

 if [ -e $xfcepath/xfconf/xfce-perchannel-xml/displays.xml ]; then
echo '<?xml version="1.0" encoding="UTF-8"?>

<channel name="displays" version="1.0">
  <property name="Notify" type="bool" value="true"/>
</channel>' > $xfcepath/xfconf/xfce-perchannel-xml/displays.xml
 fi

done

rm -f $HOME/.screenlayout/* 2>/dev/null
rm -f $HOME/.config/monitors.xml 2>/dev/null
rm -f $HOME/.kde/share/apps/kscreen/* 2>/dev/null
rm -f $HOME/.kde/local/share/apps/kscreen/* 2>/dev/null
rm -f $HOME/.kde/share/config/krandrc 2>/dev/null
rm -f $HOME/.kde4/share/apps/kscreen/* 2>/dev/null
rm -f $HOME/.kde4/local/share/apps/kscreen/* 2>/dev/null
rm -f $HOME/.kde4/share/config/krandrc 2>/dev/null
rm -f $HOME/.local/share/kscreen/* 2>/dev/null
rm -f $HOME/.zarfy/* 2>/dev/null

if [ -d /home ]; then

 for lxf in $(find /home -name "lxrandr-autostart.desktop" -type f | grep "/.config/autostart/")	
 do
  if [ "$lxf" != "" ]; then
	rm -f $lxf 
  fi
 done
 
 for usr1 in $(ls -1 /home 2>/dev/null | tr '\n' ' ')
 do

	if [ -f /home/$usr1/.config/xfce4/xfconf/xfce-perchannel-xml/displays.xml ]; then
	echo '<?xml version="1.0" encoding="UTF-8"?>

	<channel name="displays" version="1.0">
	  <property name="Notify" type="bool" value="true"/>
	</channel>' > /home/$usr1/.config/xfce4/xfconf/xfce-perchannel-xml/displays.xml
	fi

	if [ -f /home/$usr1/.config/xfce/xfconf/xfce-perchannel-xml/displays.xml ]; then
	echo '<?xml version="1.0" encoding="UTF-8"?>

	<channel name="displays" version="1.0">
	  <property name="Notify" type="bool" value="true"/>
	</channel>' > /home/$usr1/.config/xfce/xfconf/xfce-perchannel-xml/displays.xml
	fi

	  rm -f /home/$usr1/.screenlayout/* 2>/dev/null
	  rm -f /home/$usr1/.config/monitors.xml 2>/dev/null
	  rm -f /home/$usr1/.kde/share/apps/kscreen/* 2>/dev/null
	  rm -f /home/$usr1/.kde/local/share/apps/kscreen/* 2>/dev/null
	  rm -f /home/$usr1/.kde/share/config/krandrc 2>/dev/null
	  rm -f /home/$usr1/.kde4/share/apps/kscreen/* 2>/dev/null
	  rm -f /home/$usr1/.kde4/local/share/apps/kscreen/* 2>/dev/null
	  rm -f /home/$usr1/.kde4/share/config/krandrc 2>/dev/null
	  rm -f /home/$usr1/.local/share/kscreen/* 2>/dev/null
	  rm -f /home/$usr1/.zarfy/* 2>/dev/null
	  
 done
 
fi
		
}

get_edid_hash() {

for medid in $(ls -1 /sys/class/drm/*/edid 2>/dev/null | grep "card" | grep "-")
do
 sc1="$(dirname $medid)/status"
 [ "$(cat $sc1)" == "connected" ] && md5sum $medid
done
		
}

config_video() {
	
[ ! -d /var/hwdata ] && mkdir -p /var/hwdata

if [ ! -f /var/hwdata/screen.lst ]; then
 xConfig=1
elif [ ! -f /var/hwdata/videocards.lst ]; then
 xConfig=1
else
 xConfig=0
fi	

if [ $xConfig -eq 0 ]; then

    vlist="$(busybox lspci | grep "Class 03" | cut -c 21-29 | sort)"
    ocard="$(cat /var/hwdata/videocards.lst 2>/dev/null)"
    
    #Check if video card change
    if [ "$vlist" != "$ocard" ]; then
      #Video card change. Remember videocard
      echo "$vlist" > /var/hwdata/videocards.lst
      xConfig=1
    else
     xScreens="$(get_edid_hash)"
     oScreens="$(cat /var/hwdata/screen.lst 2>/dev/null)"
      #Check if screen doesn't change
       if [ "$xScreens" != "$oScreens" ]; then
         #Screen setup changed. Remember screen setup
         echo "$xScreens" > /var/hwdata/screen.lst
		 xConfig=1
       fi
    fi
    
fi

if [ $xConfig -ne 0 ]; then
  xorgwizard-automatic 
  reset_monitor_settings
  busybox lspci | grep "Class 03" | cut -c 21-29 | sort > /var/hwdata/videocards.lst
  get_edid_hash > /var/hwdata/screen.lst
fi
	
}

[ -z $DISPLAY ] || exit

export TEXTDOMAIN=xwin
export OUTPUT_CHARSET=UTF-8

. /etc/rc.d/PUPSTATE # variables created at bootup by init script in initrd...
. /etc/DISTRO_SPECS # PUPMODE=current operating configuration,
. /etc/rc.d/BOOTCONSTRAINED


if ! command -v Xorg >/dev/null 2>&1 ; then
	exit
fi

if [ -f /var/local/xwin_disable_xerrs_log_flag ] ; then
	LOGFILE_X='/dev/null'
else
	LOGFILE_X='/var/log/xerrs.log'
fi

# Create /tmp/{.ICE-unix,.X11-unix} if they are not present:
if [ ! -e /tmp/.ICE-unix ]; then
  mkdir -p /tmp/.ICE-unix
  chmod 1777 /tmp/.ICE-unix
fi

if [ ! -e /tmp/.X11-unix ]; then
  mkdir -p /tmp/.X11-unix
  chmod 1777 /tmp/.X11-unix
fi

# Clear /tmp/{.ICE-unix,.X11-unix}:
rm -f /tmp/.ICE-unix/* /tmp/.X11-unix/*

[ `id -u` -eq 0 -a ! -e /usr/bin/X ] && ln -snf Xorg /usr/bin/X

[ ! -e /var/local/icons/home48.png ] && ln -fs /usr/local/lib/X11/pixmaps/* /var/local/icons/

# in some very strange situations this file might be empty
[ ! -s /etc/X11/xorg.conf ] && rm -f /etc/X11/xorg.conf

# Puppy Xorg Video Wizard...
# boot param pfix=xorgwizard
if [ -f /tmp/xwin_xorgwizard_cli ] ; then 
	rm -f /tmp/xwin_xorgwizard_cli
	xorgwizard-cli
	xorgwizard-automatic
# normal operation
elif [ -f /etc/X11/xorg.conf ];then
	USING_DRIVER=$(grep '#card0driver' /etc/X11/xorg.conf | grep -v '#.*Driver')
	DRVRSPATH='/usr/lib/xorg/modules/drivers'
	if [ -d /usr/lib64/xorg/modules/drivers ] ; then
		DRVRSPATH='/usr/lib64/xorg/modules/drivers'
	fi
	if [ "$USING_DRIVER" -a -d "$DRVRSPATH" ] ; then #find location of video chip drivers...
		CURRENT_DRIVER="`grep '#card0driver' /etc/X11/xorg.conf | cut -f 2 -d '"'`"
		if [ "$CURRENT_DRIVER" ];then
			if ! [ "`find $DRVRSPATH -type f -name "*${CURRENT_DRIVER}*"`" ] ; then
				#driver file not found, comment out
				sed -i "s|.*#card0driver|#	Driver      \"${CURRENT_DRIVER}\" #card0driver|" /etc/X11/xorg.conf
			fi
		fi
	fi
else
	#* /etc/X11/xorg.conf does not exist *
	
	if [ "$DISTRO_XORG_AUTO" != "yes" -o -f /var/local/xwin_no_xorg_auto_flag ] ; then
		xorgwizard-cli # 1st dialog offers to use Xorg vesa...
	fi
	xorgwizard-automatic
fi

if [ "$(uname -m | grep -E "[i|x]*86")" != "" ] || [ "$(uname -m)" == "x86_64" ]; then
 config_video
fi


# automatic network reconnect. refer /usr/sbin/hostname-set
if [ -f /tmp/services/network_default_reconnect_required_flag ];then
	rm -f /tmp/services/network_default_reconnect_required_flag
	IFCONFIG="`ifconfig | grep '^[pwe]' | grep -v 'wmaster'`" #precaution.
	[ "$IFCONFIG" = "" ] && network_default_connect #/usr/sbin
fi
